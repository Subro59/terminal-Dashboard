<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .table-container {
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track { background: #1e293b; }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 20px;
        }

        tr:hover td { background-color: rgba(51, 65, 85, 0.5); }

        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .pulse-error { animation: pulse-red 2s infinite; }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .validation-error {
            border-color: #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">

    <div class="max-w-full mx-auto space-y-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">Terminal Dashboard</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="connection-status" class="w-3 h-3 rounded-full bg-slate-600"></span>
                    <p id="status-text" class="text-slate-400 text-sm font-medium italic">Initializing system...</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="sync-btn" onclick="fetchSheetData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl flex items-center gap-2 transition-all active:scale-95 font-semibold shadow-lg shadow-blue-500/25">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> 
                    <span>Sync Live Data</span>
                </button>
                <div class="text-right hidden lg:block border-l border-slate-700 pl-6">
                    <p id="current-date" class="text-xs font-bold text-blue-400 uppercase tracking-widest"></p>
                    <p id="current-time" class="text-2xl font-mono font-bold"></p>
                </div>
            </div>
        </header>

        <!-- Stats Overview -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-card p-6 flex items-center justify-between border-t-2 border-t-blue-500">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Terminals</p>
                    <h3 class="text-4xl font-bold mt-2" id="stat-total">0</h3>
                </div>
                <div class="bg-blue-500/10 p-4 rounded-2xl"><i class="fas fa-server text-blue-500 text-2xl"></i></div>
            </div>
            <div class="glass-card p-6 flex items-center justify-between border-t-2 border-t-emerald-500">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Deployed</p>
                    <h3 class="text-4xl font-bold mt-2 text-emerald-400" id="stat-live">0</h3>
                </div>
                <div class="bg-emerald-500/10 p-4 rounded-2xl"><i class="fas fa-satellite-dish text-emerald-500 text-2xl"></i></div>
            </div>
            <div class="glass-card p-6 flex items-center justify-between border-t-2 border-t-purple-500">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">System v2.0</p>
                    <h3 class="text-4xl font-bold mt-2 text-purple-400" id="stat-v2">0</h3>
                </div>
                <div class="bg-purple-500/10 p-4 rounded-2xl"><i class="fas fa-microchip text-purple-500 text-2xl"></i></div>
            </div>
        </section>

        <!-- Main Data Table -->
        <section>
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <h2 class="text-xl font-bold flex items-center gap-3">
                    <span class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <i class="fas fa-database text-emerald-500 text-sm"></i>
                    </span>
                    Live Terminal Inventory
                </h2>
                <div class="relative group">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="tableSearch" placeholder="Search TID, Merchant or Location..." class="bg-slate-800/50 border border-slate-700 rounded-xl pl-12 pr-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white w-full md:w-96 transition-all">
                </div>
            </div>
            
            <div class="glass-card overflow-hidden shadow-2xl">
                <div id="loading-overlay" class="hidden py-32 text-center">
                    <div class="relative inline-block">
                        <div class="w-16 h-16 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-slate-400 mt-6 font-medium animate-pulse" id="loading-text">Fetching live data...</p>
                    <p id="debug-info" class="text-[10px] text-slate-600 mt-2 font-mono"></p>
                </div>

                <div class="table-container overflow-x-auto" id="table-wrapper">
                    <table class="w-full text-left border-collapse min-w-[4500px]">
                        <thead>
                            <tr class="bg-slate-800/80 text-slate-400 text-[11px] uppercase tracking-[0.2em] font-black">
                                <th class="p-5 border-b border-slate-700">S/N</th>
                                <th class="p-5 border-b border-slate-700">TID</th>
                                <th class="p-5 border-b border-slate-700">MID</th>
                                <th class="p-5 border-b border-slate-700">Merchant Name</th>
                                <th class="p-5 border-b border-slate-700">DBA Name</th>
                                <th class="p-5 border-b border-slate-700">Address</th>
                                <th class="p-5 border-b border-slate-700">Contact Name</th>
                                <th class="p-5 border-b border-slate-700">Contact Number</th>
                                <th class="p-5 border-b border-slate-700">District</th>
                                <th class="p-5 border-b border-slate-700">Division</th>
                                <th class="p-5 border-b border-slate-700">Zone</th>
                                <th class="p-5 border-b border-slate-700">POS S/N</th>
                                <th class="p-5 border-b border-slate-700">Operator</th>
                                <th class="p-5 border-b border-slate-700">SIM Number</th>
                                <th class="p-5 border-b border-slate-700">SIM IP</th>
                                <th class="p-5 border-b border-slate-700">Host IP</th>
                                <th class="p-5 border-b border-slate-700">Host Port</th>
                                <th class="p-5 border-b border-slate-700">Vendor</th>
                                <th class="p-5 border-b border-slate-700">EMI Tenur</th>
                                <th class="p-5 border-b border-slate-700">Min Amount</th>
                                <th class="p-5 border-b border-slate-700">Remarks</th>
                                <th class="p-5 border-b border-slate-700">Config By</th>
                                <th class="p-5 border-b border-slate-700">Config Date</th>
                                <th class="p-5 border-b border-slate-700">Deploy By</th>
                                <th class="p-5 border-b border-slate-700">Deploy Date</th>
                                <th class="p-5 border-b border-slate-700">Roll-out By</th>
                                <th class="p-5 border-b border-slate-700">Roll-out Date</th>
                                <th class="p-5 border-b border-slate-700">Version</th>
                            </tr>
                        </thead>
                        <tbody id="terminalTableBody" class="text-sm text-slate-300 divide-y divide-slate-800"></tbody>
                    </table>
                </div>
                
                <div class="p-5 border-t border-slate-700 bg-slate-900/50 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span id="last-sync-badge" class="bg-slate-800 text-slate-400 px-3 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider">Session Initialized</span>
                    </div>
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">
                        Records: <span id="total-count" class="text-blue-400">0</span> | 
                        Match: <span id="visible-count" class="text-emerald-400">0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Update Section (Now under the Inventory) -->
        <section class="glass-card p-6 border-l-4 border-l-blue-500">
            <div class="flex items-center gap-3 mb-6">
                <span class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                    <i class="fas fa-edit text-blue-500"></i>
                </span>
                <div>
                    <h2 class="text-xl font-bold text-white">Update Deployment Info</h2>
                    <p class="text-slate-400 text-xs">Modifying specific parameters for a registered TID</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Target TID <span class="text-red-500">*</span></label>
                    <input type="text" id="update-tid" placeholder="TID Required" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Deploy By</label>
                    <input type="text" id="update-deploy-by" placeholder="Name" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Deploy Date</label>
                    <input type="date" id="update-deploy-date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Roll-out By</label>
                    <input type="text" id="update-roll-by" placeholder="Name" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Roll-out Date</label>
                    <input type="date" id="update-roll-date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Version</label>
                    <select id="update-version" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                        <option value="">- Select -</option>
                        <option value="1.0">V1.0</option>
                        <option value="2.0">V2.0</option>
                        <option value="2.1">V2.1</option>
                        <option value="3.0">V3.0</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-between items-center">
                <p class="text-[10px] text-slate-500 italic max-w-md">
                    * If Deploy By is provided, Deploy Date is required. If Roll-out By is provided, Roll-out Date & Version are required.
                </p>
                <button onclick="submitUpdate()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-2.5 rounded-xl font-bold flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-emerald-500/20">
                    <i class="fas fa-check-circle"></i>
                    Save Update
                </button>
            </div>
        </section>
    </div>

    <!-- Notification Overlay -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 pointer-events-none font-bold text-sm z-50"></div>

    <script>
        const SCRIPT_ID = 'AKfycbwuM4K_keHHxyJSY6RmtSzWljiClcXWUC2eEkZ4DNN5fQaSDasVRx8E6YM-Zin7_Rgo0A';
        const API_URL = `https://script.google.com/macros/s/${SCRIPT_ID}/exec`;
        let terminalData = [];

        async function fetchSheetData() {
            showLoading();
            setOnlineStatus('pending');
            const debug = document.getElementById('debug-info');
            debug.textContent = "Negotiating secure link...";

            const existing = document.getElementById('data-bridge');
            if (existing) existing.remove();

            const callbackName = 'google_jsonp_' + Math.round(Math.random() * 1000000);
            
            window[callbackName] = function(response) {
                handleDataResponse(response);
                delete window[callbackName];
                clearTimeout(timeoutHandle);
            };

            const script = document.createElement('script');
            script.id = 'data-bridge';
            script.src = `${API_URL}?callback=${callbackName}&t=${Date.now()}`;
            
            const timeoutHandle = setTimeout(() => {
                if (document.getElementById('loading-overlay').classList.contains('hidden')) return;
                setOnlineStatus('error', "CORS/Handshake Timeout");
                hideLoading();
                if (terminalData.length === 0) populateOfflineMode();
            }, 15000);

            script.onerror = () => {
                setOnlineStatus('error', "Shield Block (CORS)");
                hideLoading();
                if (terminalData.length === 0) populateOfflineMode();
            };

            document.body.appendChild(script);
        }

        function handleDataResponse(response) {
            setOnlineStatus('connected');
            const raw = response.data || response.items || response.records || (Array.isArray(response) ? response : null);
            
            if (raw && Array.isArray(raw)) {
                processRows(raw);
                renderUI();
                document.getElementById('last-sync-badge').textContent = "Synced: " + new Date().toLocaleTimeString();
            } else {
                setOnlineStatus('error', "Malformed Data Packet");
            }
            hideLoading();
        }

        function processRows(rows) {
            if (!rows || rows.length === 0) return;
            const firstRowStr = JSON.stringify(rows[0]).toLowerCase();
            const startIdx = firstRowStr.includes('tid') || firstRowStr.includes('merchant') ? 1 : 0;
            
            terminalData = rows.slice(startIdx)
                .filter(r => r && r.length > 1)
                .map((row, i) => ({
                    sn: row[0] || (i + 1),
                    tid: String(row[1] || '').trim(),
                    mid: row[2] || '',
                    merchant: row[3] || '',
                    dba: row[4] || '',
                    address: row[5] || '',
                    contact: row[6] || '',
                    phone: row[7] || '',
                    district: row[8] || '',
                    division: row[9] || '',
                    zone: row[10] || '',
                    pos_sn: row[11] || '',
                    operator: row[12] || '',
                    sim: row[13] || '',
                    sim_ip: row[14] || '',
                    host_ip: row[15] || '',
                    port: row[16] || '',
                    vendor: row[17] || '',
                    emi: row[18] || '',
                    min_amt: row[19] || '',
                    remarks: row[20] || '',
                    conf_by: row[21] || '',
                    conf_date: row[22] || '',
                    depl_by: row[23] || '',
                    depl_date: row[24] || '',
                    roll_by: row[25] || '',
                    roll_date: row[26] || '',
                    version: row[27] || '1.0'
                }));
        }

        function renderUI() {
            const tbody = document.getElementById('terminalTableBody');
            tbody.innerHTML = '';
            
            terminalData.forEach(item => {
                const row = document.createElement('tr');
                row.id = `tid-row-${item.tid}`;
                row.className = "hover:bg-blue-500/5 transition-colors group";
                
                const cells = [
                    item.sn, item.tid, item.mid, item.merchant, item.dba, item.address,
                    item.contact, item.phone, item.district, item.division, item.zone,
                    item.pos_sn, item.operator, item.sim, item.sim_ip, item.host_ip,
                    item.port, item.vendor, item.emi, item.min_amt, item.remarks,
                    item.conf_by, item.conf_date, item.depl_by, item.depl_date,
                    item.roll_by, item.roll_date, item.version
                ];

                row.innerHTML = cells.map((c, idx) => {
                    let content = c || '-';
                    if (idx === 1) content = `<span class="font-mono font-bold text-blue-400">${c}</span>`;
                    if (idx === 3) content = `<span class="text-white font-medium">${c}</span>`;
                    if (idx === 24) content = `<span class="text-emerald-400 font-semibold">${c}</span>`;
                    if (idx === 27) content = `<span class="status-badge ${String(c).startsWith('2') ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}">V${c}</span>`;
                    return `<td class="p-5 whitespace-nowrap border-r border-slate-800/30 last:border-0">${content}</td>`;
                }).join('');
                
                tbody.appendChild(row);
            });

            document.getElementById('stat-total').textContent = terminalData.length.toLocaleString();
            document.getElementById('stat-live').textContent = terminalData.filter(t => t.depl_date && t.depl_date !== '-').length.toLocaleString();
            document.getElementById('stat-v2').textContent = terminalData.filter(t => String(t.version).startsWith('2')).length.toLocaleString();
            document.getElementById('total-count').textContent = terminalData.length;
            document.getElementById('visible-count').textContent = terminalData.length;
        }

        function submitUpdate() {
            // Reset validation states
            document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));

            const tidInput = document.getElementById('update-tid');
            const deployByInput = document.getElementById('update-deploy-by');
            const deployDateInput = document.getElementById('update-deploy-date');
            const rollByInput = document.getElementById('update-roll-by');
            const rollDateInput = document.getElementById('update-roll-date');
            const versionInput = document.getElementById('update-version');

            const tid = tidInput.value.trim();
            const deployBy = deployByInput.value.trim();
            const deployDate = deployDateInput.value;
            const rollBy = rollByInput.value.trim();
            const rollDate = rollDateInput.value;
            const version = versionInput.value;

            // 1. Mandatory TID check
            if (!tid) {
                tidInput.classList.add('validation-error');
                showToast("Please enter a Target TID", "error");
                return;
            }

            const record = terminalData.find(t => t.tid === tid);
            if (!record) {
                tidInput.classList.add('validation-error');
                showToast(`TID ${tid} not found`, "error");
                return;
            }

            // 2. Deployment Block Validation
            if (deployBy && !deployDate) {
                deployDateInput.classList.add('validation-error');
                showToast("Deploy Date is required if Deploy By is filled", "error");
                return;
            }

            // 3. Roll-out Block Validation
            if (rollBy && (!rollDate || !version)) {
                if (!rollDate) rollDateInput.classList.add('validation-error');
                if (!version) versionInput.classList.add('validation-error');
                showToast("Roll-out Date & Version are required if Roll-out By is filled", "error");
                return;
            }

            // Check if anything is actually being updated
            if (!deployBy && !rollBy && !version) {
                showToast("Enter at least one update field", "error");
                return;
            }

            const updateData = {
                action: 'update',
                tid: tid,
                deployBy: deployBy,
                deployDate: deployDate,
                rollBy: rollBy,
                rollDate: rollDate,
                version: version
            };

            showToast(`Applying update to TID: ${tid}...`);
            
            // Local Update simulation
            if (deployBy) {
                record.depl_by = updateData.deployBy;
                record.depl_date = updateData.deployDate;
            }
            if (rollBy) {
                record.roll_by = updateData.rollBy;
                record.roll_date = updateData.rollDate;
                record.version = updateData.version;
            } else if (version && !rollBy) {
                // If only version changed
                record.version = updateData.version;
            }

            renderUI();
            
            const row = document.getElementById(`tid-row-${tid}`);
            if (row) {
                row.classList.add('bg-emerald-500/20');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => row.classList.remove('bg-emerald-500/20'), 3000);
            }

            // Clear inputs
            [tidInput, deployByInput, deployDateInput, rollByInput, rollDateInput].forEach(i => i.value = '');
            versionInput.selectedIndex = 0;

            showToast("Update processed successfully!");
        }

        function showToast(msg, type = "info") {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.backgroundColor = type === 'error' ? '#ef4444' : '#2563eb';
            toast.classList.remove('translate-y-24', 'opacity-0');
            toast.classList.add('-translate-y-6', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('translate-y-24', 'opacity-0');
                toast.classList.remove('-translate-y-6', 'opacity-100');
            }, 4000);
        }

        function setOnlineStatus(type, msg = "") {
            const dot = document.getElementById('connection-status');
            const text = document.getElementById('status-text');
            dot.className = "w-3 h-3 rounded-full";
            
            if (type === 'connected') {
                dot.classList.add('bg-emerald-500', 'shadow-[0_0_8px_rgba(16,185,129,0.5)]');
                text.textContent = "Live Stream Active";
                text.className = "text-emerald-400 text-sm font-medium";
            } else if (type === 'pending') {
                dot.classList.add('bg-blue-500', 'animate-pulse');
                text.textContent = "Syncing with master node...";
                text.className = "text-blue-400 text-sm font-medium italic";
            } else {
                dot.classList.add('bg-red-500', 'pulse-error');
                text.textContent = msg || "Connection Refused";
                text.className = "text-red-400 text-sm font-bold";
            }
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('table-wrapper').classList.add('opacity-10');
            document.getElementById('refresh-icon').classList.add('fa-spin');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('table-wrapper').classList.remove('opacity-10');
            document.getElementById('refresh-icon').classList.remove('fa-spin');
        }

        function populateOfflineMode() {
            document.getElementById('terminalTableBody').innerHTML = `
                <tr>
                    <td colspan="28" class="p-20 text-center">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-shield-alt text-3xl text-orange-500 mb-4"></i>
                            <h4 class="text-white font-bold mb-2">Transport Security Error</h4>
                            <p class="text-slate-400 max-w-md mb-6">Security policy blocking connection. Ensure the Apps Script is deployed as a Web App for "Anyone".</p>
                            <button onclick="fetchSheetData()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition-all">Retry Handshake</button>
                        </div>
                    </td>
                </tr>`;
        }

        function initClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour12: false });
            };
            update(); setInterval(update, 1000);
        }

        window.onload = () => {
            initClock();
            fetchSheetData();
            
            document.getElementById('tableSearch').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#terminalTableBody tr');
                let count = 0;
                rows.forEach(row => {
                    const match = row.textContent.toLowerCase().includes(term);
                    row.style.display = match ? '' : 'none';
                    if (match) count++;
                });
                document.getElementById('visible-count').textContent = count;
            });
        };
    </script>
</body>
</html>
