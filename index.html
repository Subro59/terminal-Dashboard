<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .table-container {
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .table-container::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 20px;
        }

        tr:hover td {
            background-color: rgba(51, 65, 85, 0.5);
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        #api-script-container { display: none; }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">

    <div id="api-script-container"></div>

    <div class="max-w-full mx-auto space-y-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Terminal Dashboard</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span id="connection-status" class="w-2 h-2 rounded-full bg-red-500"></span>
                    <p id="status-text" class="text-slate-400 text-sm">System Offline</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="fetchSheetData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl flex items-center gap-2 transition-all active:scale-95 font-semibold shadow-lg shadow-blue-500/25">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> 
                    <span>Sync Live Data</span>
                </button>
                <div class="text-right hidden lg:block border-l border-slate-700 pl-6">
                    <p id="current-date" class="text-xs font-bold text-blue-400 uppercase tracking-widest"></p>
                    <p id="current-time" class="text-2xl font-mono font-bold"></p>
                </div>
            </div>
        </header>

        <!-- Stats Overview -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="glass-card p-6 flex items-center justify-between border-t-2 border-t-blue-500">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Total Terminals</p>
                    <h3 class="text-4xl font-bold mt-2" id="stat-total">0</h3>
                </div>
                <div class="bg-blue-500/10 p-4 rounded-2xl"><i class="fas fa-server text-blue-500 text-2xl"></i></div>
            </div>
            <div class="glass-card p-6 flex items-center justify-between border-t-2 border-t-emerald-500">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">Deployed</p>
                    <h3 class="text-4xl font-bold mt-2 text-emerald-400" id="stat-live">0</h3>
                </div>
                <div class="bg-emerald-500/10 p-4 rounded-2xl"><i class="fas fa-satellite-dish text-emerald-500 text-2xl"></i></div>
            </div>
            <div class="glass-card p-6 flex items-center justify-between border-t-2 border-t-purple-500">
                <div>
                    <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">System v2.0</p>
                    <h3 class="text-4xl font-bold mt-2 text-purple-400" id="stat-v2">0</h3>
                </div>
                <div class="bg-purple-500/10 p-4 rounded-2xl"><i class="fas fa-microchip text-purple-500 text-2xl"></i></div>
            </div>
        </section>

        <!-- Main Data Table -->
        <section>
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <h2 class="text-xl font-bold flex items-center gap-3">
                    <span class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <i class="fas fa-database text-emerald-500 text-sm"></i>
                    </span>
                    Live Terminal Inventory
                </h2>
                <div class="relative group">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-blue-500 transition-colors"></i>
                    <input type="text" id="tableSearch" placeholder="Search TID, Merchant or Location..." class="bg-slate-800/50 border border-slate-700 rounded-xl pl-12 pr-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white w-full md:w-96 transition-all">
                </div>
            </div>
            
            <div class="glass-card overflow-hidden shadow-2xl">
                <div id="loading-overlay" class="hidden py-32 text-center">
                    <div class="relative inline-block">
                        <div class="w-16 h-16 border-4 border-blue-500/20 border-t-blue-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-slate-400 mt-6 font-medium animate-pulse" id="loading-text">Fetching live data from Google Sheets...</p>
                </div>

                <div class="table-container overflow-x-auto" id="table-wrapper">
                    <table class="w-full text-left border-collapse min-w-[4500px]">
                        <thead>
                            <tr class="bg-slate-800/80 text-slate-400 text-[11px] uppercase tracking-[0.2em] font-black">
                                <th class="p-5 border-b border-slate-700">S/N</th>
                                <th class="p-5 border-b border-slate-700">TID</th>
                                <th class="p-5 border-b border-slate-700">MID</th>
                                <th class="p-5 border-b border-slate-700">Merchant Name</th>
                                <th class="p-5 border-b border-slate-700">DBA Name</th>
                                <th class="p-5 border-b border-slate-700">Address</th>
                                <th class="p-5 border-b border-slate-700">Contact Name</th>
                                <th class="p-5 border-b border-slate-700">Contact Number</th>
                                <th class="p-5 border-b border-slate-700">District</th>
                                <th class="p-5 border-b border-slate-700">Division</th>
                                <th class="p-5 border-b border-slate-700">Zone</th>
                                <th class="p-5 border-b border-slate-700">POS S/N</th>
                                <th class="p-5 border-b border-slate-700">Operator</th>
                                <th class="p-5 border-b border-slate-700">SIM Number</th>
                                <th class="p-5 border-b border-slate-700">SIM IP</th>
                                <th class="p-5 border-b border-slate-700">Host IP</th>
                                <th class="p-5 border-b border-slate-700">Host Port</th>
                                <th class="p-5 border-b border-slate-700">Vendor</th>
                                <th class="p-5 border-b border-slate-700">EMI Tenur</th>
                                <th class="p-5 border-b border-slate-700">Min Amount</th>
                                <th class="p-5 border-b border-slate-700">Remarks</th>
                                <th class="p-5 border-b border-slate-700">Config By</th>
                                <th class="p-5 border-b border-slate-700">Config Date</th>
                                <th class="p-5 border-b border-slate-700">Deploy By</th>
                                <th class="p-5 border-b border-slate-700">Deploy Date</th>
                                <th class="p-5 border-b border-slate-700">Roll-out By</th>
                                <th class="p-5 border-b border-slate-700">Roll-out Date</th>
                                <th class="p-5 border-b border-slate-700">Version</th>
                            </tr>
                        </thead>
                        <tbody id="terminalTableBody" class="text-sm text-slate-300 divide-y divide-slate-800"></tbody>
                    </table>
                </div>
                
                <!-- Table Footer -->
                <div class="p-5 border-t border-slate-700 bg-slate-900/50 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <span id="last-sync-badge" class="bg-slate-800 text-slate-400 px-3 py-1 rounded-md text-[10px] font-bold uppercase">Not Synced</span>
                    </div>
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-widest">
                        Total Records: <span id="total-count" class="text-blue-400">0</span> | 
                        Filtered: <span id="visible-count" class="text-emerald-400">0</span>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // CORE API CONFIGURATION
        const API_URL = 'https://script.google.com/macros/s/AKfycbwuM4K_keHHxyJSY6RmtSzWljiClcXWUC2eEkZ4DNN5fQaSDasVRx8E6YM-Zin7_Rgo0A/exec';
        let terminalData = [];
        let isFetching = false;

        /**
         * GLOBAL CALLBACK FOR JSONP
         * This must remain in the global window scope
         */
        window.handleApiResponse = function(response) {
            console.log("Data Payload Received:", response);
            isFetching = false;
            
            // Handle various possible GAS response structures
            const raw = response.data || response.items || response.records || (Array.isArray(response) ? response : null);
            
            if (raw && Array.isArray(raw)) {
                processData(raw);
                setOnlineStatus(true);
                renderTable();
                updateStats();
                document.getElementById('last-sync-badge').textContent = "Synced: " + new Date().toLocaleTimeString();
            } else {
                showError("Invalid data format received.");
            }
            hideLoading();
        };

        async function fetchSheetData() {
            if (isFetching) return;
            isFetching = true;
            
            showLoading();
            const timestamp = Date.now();
            const scriptUrl = `${API_URL}?callback=handleApiResponse&v=${timestamp}`;

            // Create and inject the script tag
            const container = document.getElementById('api-script-container');
            container.innerHTML = ''; // Clear previous
            
            const script = document.createElement('script');
            script.src = scriptUrl;
            script.async = true;

            // Timeout Logic
            const fetchTimeout = setTimeout(() => {
                if (isFetching) {
                    isFetching = false;
                    showError("Connection timed out. Retrying alternate method...");
                    // Try a one-off fetch as last resort
                    fetchFallback();
                }
            }, 12000);

            script.onerror = () => {
                clearTimeout(fetchTimeout);
                isFetching = false;
                showError("CORS/MIME Blocked. Check App Script Deployment.");
                hideLoading();
                if (terminalData.length === 0) loadMockData();
            };

            container.appendChild(script);
        }

        async function fetchFallback() {
            try {
                // This will likely fail CORS but in some browser configs it triggers the redirect cache
                await fetch(API_URL, { mode: 'no-cors' });
                document.getElementById('loading-text').textContent = "Waiting for redirect response...";
            } catch(e) {
                console.error("Fallback failed", e);
            }
        }

        function processData(rows) {
            if (!rows || rows.length === 0) return;
            
            // Detect if first row is headers
            const firstRowStr = String(rows[0][0] || '').toLowerCase();
            const hasHeader = firstRowStr.includes('s/n') || firstRowStr.includes('tid');
            const dataRows = hasHeader ? rows.slice(1) : rows;

            terminalData = dataRows.filter(row => row.length > 0).map((row, i) => ({
                sn: row[0] || (i + 1),
                tid: row[1] || 'N/A',
                mid: row[2] || '',
                merchant: row[3] || '',
                dba: row[4] || '',
                address: row[5] || '',
                contact: row[6] || '',
                phone: row[7] || '',
                district: row[8] || '',
                division: row[9] || '',
                zone: row[10] || '',
                pos_sn: row[11] || '',
                operator: row[12] || '',
                sim: row[13] || '',
                sim_ip: row[14] || '',
                host_ip: row[15] || '',
                port: row[16] || '',
                vendor: row[17] || '',
                emi: row[18] || '',
                min_amt: row[19] || '',
                remarks: row[20] || '',
                conf_by: row[21] || '',
                conf_date: row[22] || '',
                depl_by: row[23] || '',
                depl_date: row[24] || '',
                roll_by: row[25] || '',
                roll_date: row[26] || '',
                version: row[27] || '1.0'
            }));
        }

        function renderTable() {
            const tbody = document.getElementById('terminalTableBody');
            tbody.innerHTML = '';
            
            if (terminalData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="28" class="p-20 text-center text-slate-500 font-medium italic">No terminal records found. Check your spreadsheet.</td></tr>';
                return;
            }

            terminalData.forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-blue-500/5 transition-colors group";
                
                const cols = [
                    item.sn, 
                    `<span class="font-mono font-bold text-blue-400">${item.tid}</span>`, 
                    item.mid, 
                    `<span class="text-white font-medium">${item.merchant}</span>`,
                    item.dba, item.address, item.contact, item.phone, item.district, item.division,
                    item.zone, item.pos_sn, item.operator, item.sim, item.sim_ip, item.host_ip, 
                    item.port, item.vendor, item.emi, item.min_amt, item.remarks,
                    item.conf_by, item.conf_date, item.depl_by, 
                    `<span class="text-emerald-400 font-semibold">${item.depl_date}</span>`,
                    item.roll_by, item.roll_date,
                    `<span class="status-badge ${String(item.version).startsWith('2') ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'}">V${item.version}</span>`
                ];
                
                row.innerHTML = cols.map(c => `<td class="p-5 whitespace-nowrap border-r border-slate-800/30 last:border-0">${c || '-'}</td>`).join('');
                tbody.appendChild(row);
            });

            document.getElementById('total-count').textContent = terminalData.length;
            document.getElementById('visible-count').textContent = terminalData.length;
        }

        function updateStats() {
            const total = terminalData.length;
            const deployed = terminalData.filter(t => String(t.depl_date).trim() !== '').length;
            const v2 = terminalData.filter(t => String(t.version).startsWith('2')).length;
            
            animateCounter('stat-total', total);
            animateCounter('stat-live', deployed);
            animateCounter('stat-v2', v2);
        }

        function animateCounter(id, target) {
            let current = 0;
            const element = document.getElementById(id);
            const step = Math.ceil(target / 20) || 1;
            const interval = setInterval(() => {
                current += step;
                if (current >= target) {
                    element.textContent = target.toLocaleString();
                    clearInterval(interval);
                } else {
                    element.textContent = current.toLocaleString();
                }
            }, 30);
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('table-wrapper').classList.add('opacity-20', 'pointer-events-none');
            document.getElementById('refresh-icon').classList.add('fa-spin');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('table-wrapper').classList.remove('opacity-20', 'pointer-events-none');
            document.getElementById('refresh-icon').classList.remove('fa-spin');
        }

        function setOnlineStatus(online) {
            const dot = document.getElementById('connection-status');
            const text = document.getElementById('status-text');
            if (online) {
                dot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                text.textContent = "Live Link Active";
                text.className = "text-emerald-400 text-sm font-medium";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.textContent = "Connection Error";
                text.className = "text-red-400 text-sm font-medium";
            }
        }

        function showError(msg) {
            console.error(msg);
            setOnlineStatus(false);
            const badge = document.getElementById('last-sync-badge');
            badge.textContent = "Error: Connection Failed";
            badge.className = "bg-red-500/20 text-red-400 px-3 py-1 rounded-md text-[10px] font-bold uppercase";
        }

        function loadMockData() {
            terminalData = [{
                sn: 1, tid: "OFFLINE_MODE", merchant: "System couldn't reach Google API",
                remarks: "Check 'Anyone' access in GAS", version: "1.0"
            }];
            renderTable();
        }

        function initTimer() {
            const update = () => {
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour12: false });
            };
            update();
            setInterval(update, 1000);
        }

        window.onload = () => {
            initTimer();
            fetchSheetData();

            // Search filtering
            document.getElementById('tableSearch').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#terminalTableBody tr');
                let visible = 0;
                rows.forEach(row => {
                    const match = row.textContent.toLowerCase().includes(term);
                    row.style.display = match ? '' : 'none';
                    if (match) visible++;
                });
                document.getElementById('visible-count').textContent = visible;
            });
        };
    </script>
</body>
</html>
